(function() {
    const multipleChoiceIndex = 0;
    const fillTheBlanksIndex = 1;
    const questionTemplatesDir = "templates/";

    tinymce.PluginManager.add( 'ustadmobile', function( editor ){

        editor.on("preInit", function () {
            editor.parser.addAttributeFilter("data-um-widget", function(nodes, name) {
                for(node in nodes) {
                    if(!nodes.hasOwnProperty(node))
                        continue;
                    const content = tinymce.html.Serializer().serialize(nodes[node]);
                    const widget = QuestionWidget.handleQuestionNode(content);
                    const finalWidget = widget.editOn();
                    const tempNode =  tinymce.html.DomParser().parse($(finalWidget).prop('outerHTML'));
                    nodes[node].replace(tempNode);

                }
            });

        });




        var questionTypeList = ['Mutiple Choice','Fill the blanks','Editor Off'];
        var questionTemplateList = ['question-multiple-choice.html','question-fill-the-blanks.html']

        var items = [];

        tinymce.each(questionTypeList, function(questionType){
            items.push({
                text: questionType,
                onclick: function(){
                    if(questionType !== "Editor Off"){
                        const nextQuestionId = QuestionWidget.getNextQuestionId();
                        const templatePage = questionType == questionTypeList[multipleChoiceIndex]
                            ? questionTemplateList[multipleChoiceIndex] : (questionType === questionTypeList[fillTheBlanksIndex]
                                ? questionTemplateList[fillTheBlanksIndex]: "");
                        $.ajax({url: questionTemplatesDir+templatePage, success: function(templateHtmlContent){
                                const templateContentWithId = $(templateHtmlContent).attr("id",nextQuestionId);
                                const questionContent = $(templateContentWithId).prop('outerHTML');
                                tinymce.activeEditor.execCommand('mceInsertContent', false, questionContent,{format: 'raw'});
                            }});
                    }else{
                        QuestionWidget.handleEditOff();
                        tinymce.activeEditor.dom.hide(tinymce.activeEditor.dom.select('br'));
                        tinymce.activeEditor.dom.hide(tinymce.activeEditor.dom.select('label'));
                        tinymce.activeEditor.dom.hide(tinymce.activeEditor.dom.select('div.question-retry'));
                        tinymce.activeEditor.dom.hide(tinymce.activeEditor.dom.select('button.btn-default.add-choice'));
                        tinymce.activeEditor.dom.hide(tinymce.activeEditor.dom.select('div.question-choice-answer'));
                        tinymce.activeEditor.dom.hide(tinymce.activeEditor.dom.select('div.fill-blanks'));
                    }
                }
            });
        });


        /**
         * Add button to the toolbar with drop down functionality
         */
        editor.addButton( 'ustadmobile', {
            type: 'menubutton',
            text: 'Ustadmobile',
            menu: items
        });


    });
})();